name: Performance Testing
on:
  deployment_status:
  workflow_dispatch:
    inputs:
      domain:
        required: true
        default: 'tiarebalbi.com'
        description: Domain (without https)
      vus:
        required: true
        default: 1000
        description: Number of virtual users
jobs:
  k6_local_perf:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v1
      - name: Run local k6 test
        uses: k6io/action@v0.1
        with:
          filename: perf/k6-tiarebalbi.js
          flags: >-
            -e TARGET_VUS=${{ github.event.inputs.vus }} 
            -e INPUT_DOMAIN=${{ github.event.inputs.domain }} 
            -e DEPLOYMENT_DOMAIN=${{ github.event.deployment_status.target_url }} 
  google_insights_deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.issue.deployment_status }}
    steps:
      - name: Running Page Speed Insights
        uses: jakepartusch/psi-action@v1.1
        id: psi
        with:
          url: 'https://${{ github.event.deployment_status.target_url }}/'
          threshold: 80
          strategy: mobile
          
  google_insights_input:
    runs-on: ubuntu-latest
    if: ${{ github.event.issue.workflow_dispatch }}
    steps:
      - name: Running Page Speed Insights
        uses: jakepartusch/psi-action@v1.1
        id: psi
        with:
          url: 'https://${{ github.event.inputs.domain }}/'
          threshold: 80
          strategy: mobile